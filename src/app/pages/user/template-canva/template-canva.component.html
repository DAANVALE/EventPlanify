
<div *ngIf="!savedTerrace(); else showTerrace">
  <app-template-findtemplate
  [terraces]="terraces()"
  [terraceTypes]="terraceTypes()"
  [template]="template()"
  >
  </app-template-findtemplate>
</div>
<ng-template #showTerrace>
  <p-menubar>
    <ng-template pTemplate="start">
      <p class="menu-text">Terraza seleccionada:</p>
    </ng-template>
    <ng-template pTemplate="end">
      <button
        pButton
        type="button"
        icon="pi pi-arrow-left"
        class="p-button-sm p-button-rounded p-button-info mb-3"
        (click)="clearTerrace()">
        Eliminar
      </button>
    </ng-template>
  </p-menubar>

  <!-- Load component -->
  <app-template-selectedtemplate></app-template-selectedtemplate>
</ng-template>

<br>

<p-menubar class="mb-3">
  <ng-template pTemplate="start">
    <span>Servicios proporcionados</span>
  </ng-template>
  <ng-template pTemplate="end">
    <p-dropdown
      [options]="serviceTypes()"
      [(ngModel)]="selectedServiceType"
      optionLabel="kind"
      placeholder="Agregar servicio"
      (onChange)="onSelectServiceType()"
      class="p-inputtext-sm"
    ></p-dropdown>
  </ng-template>
</p-menubar>

<!-- Carruseles por tipo de servicio -->
<div *ngFor="let type of template().serviceTypeModel" class="mb-5">

  <!-- Header simple y alineado -->
  <div class="service-header mx-3 my-2">
    <div class="header-left">
      <i class="pi pi-tag text-primary mr-2"></i>
      <span style="margin-right: 10px;"></span>
      <h3 class="m-0">{{type.kind }}</h3>
    </div>
    <p-button 
      icon="pi pi-times" 
      styleClass="p-button-danger p-button-text p-button-sm"
      (click)="removeServiceType(type)"
      tooltip="Quitar tipo">
    </p-button>
  </div>

  <!-- Carrusel con cards normales -->
  <p-carousel
    [value]="getServicesByType(type)"
    [numVisible]="4"
    [numScroll]="1"
    [responsiveOptions]="responsiveOptions"
    class="service-carousel"
  >
    <ng-template pTemplate="item" let-service>
      <div class="card-container" (click)="openServiceDialog(service)">
        <p-card class="service-card">
          <img 
            [src]="service.URL_IMG?.[0] || '../../../assets/calendars.png'" 
            alt="{{service.name}}"
            class="card-image"
            (error)="onImageError($event)">
          
          <h4 class="card-title">{{ service.name }}</h4>
          
          <p class="card-description">
            {{ (service.description || '').slice(0,60) }}{{ service.description?.length > 60 ? '...' : '' }}
          </p>
          
          <div class="card-footer">
            <span class="card-price">${{ service.price || 0 }}</span>
            <p-tag 
              [value]="isServiceSelected(service) ? '✓' : '+'"
              [severity]="isServiceSelected(service) ? 'success' : 'info'"
              class="card-tag">
            </p-tag>
          </div>
        </p-card>
      </div>
    </ng-template>
  </p-carousel>
</div>

<div class="fixed bottom-4 center z-5">
  <button 
    pButton 
    label="Continuar a Confirmación" 
    icon="pi pi-arrow-right"
    class="p-button-success p-button-lg shadow-5"
    (click)="goToConfirmation()">
    
    <span class="ml-2 bg-red-500 text-white border-circle w-2rem h-2rem flex align-items-center justify-content-center" 
          style="position: absolute; top: -8px; right: -8px; font-size: 0.8rem;">
      {{ getTotalItems() }}
    </span>
  </button>
</div>

<!-- Diálogo de Detalles de Servicio -->
<p-dialog 
  header="Detalles del Servicio"
  [(visible)]="showServiceDialog"
  [modal]="true"
  [style]="{ width: '70vw', maxWidth: '800px' }"
  [breakpoints]="{ '960px': '90vw', '640px': '95vw' }"
>
  <div *ngIf="selectedService_T && selectedService_R" class="grid p-fluid">
    
    <!-- Sección de Información Principal -->
    <div class="col-12 md:col-6">
      <p-card [header]="selectedService_T.name" subHeader="Información del servicio">
        <div class="grid">
          <div class="col-12">
            <div class="field">
              <label class="font-semibold text-900 block mb-2">Descripción</label>
              <p class="text-200 surface-100 p-3 border-round text-sm line-height-3">
                {{ selectedService_T.description || 'Sin descripción' }}
              </p>
            </div>
          </div>

          <div class="col-12 md:col-6">
            <div class="field">
              <label class="font-semibold text-900 block mb-2">Capacidad Base</label>
              <p-tag [value]="(selectedService_R.baseSize || 0) + ' personas'" 
                    icon="pi pi-users" 
                    severity="info">
              </p-tag>
            </div>
          </div>

          <div class="col-12 md:col-6">
            <div class="field">
              <label class="font-semibold text-900 block mb-2">Capacidad Máxima</label>
              <p-tag [value]="(selectedService_R.maxSize || 0) + ' personas'" 
                    icon="pi pi-users" 
                    severity="success">
              </p-tag>
            </div>
          </div>

          <div class="col-12 md:col-6">
            <div class="field">
              <label class="font-semibold text-900 block mb-2">Precio +10 personas</label>
              <p-tag [value]="'$' + (selectedService_R.priceAdd10 || 0)" 
                    icon="pi pi-money-bill">
              </p-tag>
            </div>
          </div>

          <div class="col-12 md:col-6">
            <div class="field">
              <label class="font-semibold text-900 block mb-2">Precio Base</label>
              <p-tag [value]="'$' + (selectedService_T.price || 0)" 
                    icon="pi pi-dollar">
              </p-tag>
            </div>
          </div>
        </div>
      </p-card>
    </div>

    <!-- Sección de Información de Contacto -->
    <div class="col-12 md:col-6">
      <p-card header="Información de Contacto" styleClass="h-full">
        <div class="grid">
          <div class="col-12">
            <div class="field">
              <label class="font-semibold text-900 block mb-2">Proveedor</label>
              <div class="flex align-items-center gap-2 text-200 p-3 surface-100 border-round">
                <i class="pi pi-building text-primary"></i>
                <span>{{ selectedService_R.asociateServiceModel.name || 'No especificado' }}</span>
              </div>
            </div>
          </div>

          <div class="col-12 md:col-6">
            <div class="field">
              <label class="font-semibold text-900 block mb-2">Email</label>
              <div class="text-200 p-3 surface-100 border-round">
                {{ selectedService_R.asociateServiceModel.mail || 'No especificado' }}
              </div>
            </div>
          </div>

          <div class="col-12 md:col-6">
            <div class="field">
              <label class="font-semibold text-900 block mb-2">Teléfono</label>
              <div class="text-200 p-3 surface-100 border-round">
                {{ selectedService_R.asociateServiceModel.phone }}
              </div>
            </div>
          </div>

          <div class="col-12">
            <div class="field">
              <label class="font-semibold text-900 block mb-2">Dirección</label>
              <div class="text-200 p-3 surface-100 border-round">
                {{ selectedService_R.direction || 'No especificada' }}
              </div>
            </div>
          </div>
        </div>
      </p-card>
    </div>

    <!-- Sección de Acción -->
    <div class="col-12">
      <p-card header="Resumen" styleClass="h-full">
        <div class="flex flex-column gap-3">
          <div class="flex align-items-center gap-2 text-sm">
            <i class="pi pi-check-circle text-green-500"></i>
            <span>Servicio disponible para reserva</span>
          </div>
          
          <div class="flex align-items-center gap-2 text-sm">
            <i class="pi pi-info-circle text-blue-500"></i>
            <span>Capacidad: {{ selectedService_R.baseSize || 0 }} - {{ selectedService_R.maxSize || 0 }} personas</span>
          </div>

          <div class="surface-100 p-3 border-round">
            <div class="flex justify-content-between align-items-center mb-2">
              <span class="font-semibold">Precio base del servicio:</span>
              <span class="text-green-500 font-bold">${{ selectedService_T.price || 0 }}</span>
            </div>
            <div class="flex justify-content-between align-items-center">
              <span class="font-semibold">Precio +10 personas:</span>
              <span class="text-blue-500 font-bold">${{ selectedService_R.priceAdd10 || 0 }}</span>
            </div>
          </div>

          <div class="flex gap-2 justify-content-end mt-3">
            <button 
              pButton 
              label="Cerrar" 
              icon="pi pi-times" 
              class="p-button-outlined p-button-secondary"
              (click)="showServiceDialog = false">
            </button>
            
            <button 
              pButton 
              label="Seleccionar Servicio" 
              icon="pi pi-shopping-cart" 
              class="p-button-success"
              (click)="selectService(selectedService_T, selectedService_R)">
            </button>
          </div>
        </div>
      </p-card>
    </div>
  </div>
</p-dialog>