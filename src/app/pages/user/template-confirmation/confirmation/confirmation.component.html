<div class="confirmation-container p-4">
  <div class="centered-content">
    <div class="grid-container">
      
      <!-- Header -->
      <div class="text-center mb-5 mobile-center">
        <h1 class="text-3xl font-bold text-900 mb-2">Configuración de Evento</h1>
        <p class="text-600">Gestiona tu evento y servicios contratados</p>
      </div>

      <div class="grid">
        
        <!-- Columna izquierda - Evento y Servicios -->
        <div class="col-12 lg:col-8">
          
          <!-- Configuración del Evento -->
          <p-card header="Configuración del Evento" styleClass="mb-4 shadow-2 card-enhanced">
            <div class="grid p-fluid">
              
              <!-- Terraza Info -->
              <div class="col-12 mb-4 spacing-enhanced" *ngIf="eventModel().terraceModel">
                <p-fieldset legend="Terraza Seleccionada" [toggleable]="true" styleClass="fieldset-enhanced">
                  <div class="grid">
                    <div class="col-12 mobile-center">
                      <h4 class="text-900 mb-1">{{ eventModel().terraceModel?.name }}</h4>
                      <div class="flex flex-wrap gap-2">
                        <p-tag [value]="getTerraceCapacity()" icon="pi pi-users" severity="info"></p-tag>
                        <p-tag [value]="'Base: $' + (eventModel().terraceModel?.priceAdd10 || 0)" 
                               icon="pi pi-money-bill" severity="success"></p-tag>
                      </div>
                    </div>
                  </div>
                </p-fieldset>
              </div>

              <!-- Número de Personas -->
              <div class="col-12 md:col-6 mobile-center">
                <label class="font-semibold block mb-2">
                  <i class="pi pi-users mr-2"></i>Número de Personas
                </label>
                <p-inputNumber 
                  [(ngModel)]="eventForm.sizePeople"
                  [min]="eventModel().terraceModel?.baseSize || 1"
                  [max]="eventModel().terraceModel?.maxSize || 100"
                  mode="decimal"
                  (onInput)="updateEventPeople()"
                  class="w-full input-container centered-control-mobile">
                </p-inputNumber>
                <small class="text-500" *ngIf="eventModel().terraceModel">
                  Capacidad: {{ getTerraceCapacity() }}
                  <span *ngIf="getExtraPeopleCount() > 0" class="text-orange-500 ml-2">
                    (+{{ getExtraPeopleCount() }} extra)
                  </span>
                </small>
              </div>

              <!-- Notas Adicionales -->
              <div class="col-12 mobile-center">
                <label class="font-semibold block mb-2">
                  <i class="pi pi-comment mr-2"></i>Notas Adicionales
                  <br>
                </label>
                <textarea 
                  [(ngModel)]="eventForm.additionalNotes"
                  pInputTextarea
                  rows="3"
                  placeholder="Requerimientos especiales, horarios específicos, etc."
                  class="w-full textarea-controlled centered-control-mobile">
                </textarea>
              </div>

            </div>
          </p-card>

          <!-- Servicios Contratados -->
          <p-card header="Servicios Contratados" styleClass="shadow-2 card-enhanced">
            <div *ngIf="reserveModels().length > 0; else noServices">
              <div *ngFor="let reserve of reserveModels()" class="reserve-item border-bottom-1 surface-border pb-4 mb-4">
                
                <!-- Header del Servicio -->
                <div class="flex justify-content-between align-items-start mb-3">
                  <div class="flex align-items-start gap-3" style="flex: 1;">
                    <div style="flex: 1;" class="mobile-center text-left-desktop">
                      <h4 class="text-900 mb-1">{{ reserve.serviceModel?.name }}</h4>
                      <div class="flex flex-wrap gap-2">
                        <p-tag 
                          [value]="'Capacidad: ' + reserve.serviceModel?.baseSize + '-' + reserve.serviceModel?.maxSize" 
                          severity="info"
                          styleClass="text-xs">
                        </p-tag>
                        <p-tag 
                          [value]="'Base: $' + (reserve.serviceModel?.basePrice || 0)" 
                          severity="success"
                          styleClass="text-xs">
                        </p-tag>
                      </div>
                    </div>
                  </div>
                  <div class="flex gap-2">
                    <button 
                      pButton 
                      icon="pi pi-trash" 
                      class="p-button-outlined p-button-danger p-button-sm"
                      (click)="removeReserve(reserve)"
                      tooltip="Eliminar servicio">
                    </button>
                  </div>
                </div>

                <!-- Configuración Editable del Servicio -->
                <div class="grid p-fluid">
                  
                  <!-- Personas para este servicio -->
                  <div class="col-12 md:col-6 mobile-center text-left-desktop">
                    <label class="font-semibold block mb-2 text-sm">Personas para este servicio: </label>
                    <br>
                    <p-inputNumber 
                      [(ngModel)]="reserve.sizePeople"
                      [min]="reserve.serviceModel?.baseSize || 0"
                      [max]="reserve.serviceModel?.maxSize || 100"
                      mode="decimal"
                      (onInput)="updateReservePeople(reserve, $event.value)"
                      class="w-full service-input-container centered-control-mobile"
                      styleClass="p-inputtext-sm">
                    </p-inputNumber>
                    <small class="text-500 text-xs">
                      <br>
                      Base: {{ reserve.serviceModel?.baseSize }}, Máx: {{ reserve.serviceModel?.maxSize }}
                    </small>
                  </div>

                  <!-- Duración -->
                  <div class="col-12 md:col-6 mobile-center text-left-desktop">
                    <label class="font-semibold block mb-2 text-sm">Duración del servicio:</label>
                    <br>
                    <p-dropdown 
                      [(ngModel)]="reserve.dayTime"
                      [options]="timeOptions"
                      (onChange)="updateReserveTime(reserve, $event.value)"
                      class="w-full service-input-container centered-control-mobile"
                      styleClass="p-dropdown-sm">
                    </p-dropdown>
                  </div>

                  <!-- Precio Calculado -->
                  <div class="col-12">
                    <div class="flex justify-content-between align-items-center pt-2 border-top-1 surface-border">
                      <span class="font-semibold">Precio final:</span>
                      <span class="font-bold text-green-500 text-lg">
                        ${{ reserve.finalPrice || 0 }}
                      </span>
                    </div>
                  </div>

                </div>
              </div>
            </div>

            <ng-template #noServices>
              <div class="text-center p-4 text-500 mobile-center">
                <i class="pi pi-inbox text-4xl mb-3"></i>
                <p>No hay servicios contratados</p>
              </div>
            </ng-template>
          </p-card>

        </div>

        <!-- Columna derecha - Resumen y Acciones -->
        <div class="col-12 lg:col-4">
          
          <!-- Resumen de Costos -->
          <p-card header="Resumen de Costos" styleClass="mb-4 shadow-2 sticky-top card-enhanced">
            
            <!-- Terraza -->
            <div class="flex justify-content-between align-items-center mb-3">
              <div>
                <span class="font-medium block">Terraza</span>
                <small class="text-500">{{ eventForm.sizePeople }} personas</small>
              </div>
              <span class="font-semibold text-green-500">
                ${{ calculateTerracePrice() }}
              </span>
            </div>

            <!-- Servicios -->
            <div class="mb-3" *ngIf="reserveModels().length > 0">
              <span class="font-medium block mb-2">Servicios:</span>
              <div *ngFor="let reserve of reserveModels()" 
                   class="flex justify-content-between align-items-center text-sm mb-1">
                <span class="text-500">{{ reserve.serviceModel?.name }}</span>
                <span>${{ reserve.finalPrice || 0 }}</span>
              </div>
            </div>

            <p-divider></p-divider>

            <!-- Total -->
            <div class="flex justify-content-between align-items-center mb-4">
              <span class="font-bold text-lg">Total del Evento:</span>
              <span class="font-bold text-green-500 text-xl">
                ${{ calculateEventTotal() }}
              </span>
            </div>

            <!-- Botones de Acción -->
            <div class="flex flex-column gap-2 mt-4">
              <button 
                pButton 
                [label]="eventForm.payment === 'paypal' ? 'Pagar con PayPal' : 'Confirmar Evento'" 
                [icon]="eventForm.payment === 'paypal' ? 'pi pi-paypal' : 'pi pi-check'"
                class="p-button-success"
                (click)="confirmReservation()"
                [disabled]="!isFormValid()">
              </button>
              
              <button 
                pButton 
                label="Volver a Modificar" 
                icon="pi pi-arrow-left"
                class="p-button-outlined p-button-secondary"
                (click)="goBack()">
              </button>
            </div>

          </p-card>

        </div>

        <div class="col-12 lg:col-4">
          <div class="col-12 md:col-6 mobile-center">
                <label class="font-semibold block mb-2">
                  <i class="pi pi-credit-card mr-2"></i>Método de Pago:
                  <br>
                </label>
                <p-dropdown 
                  [(ngModel)]="eventForm.payment"
                  [options]="paymentOptions"
                  optionLabel="label"
                  optionValue="value"
                  placeholder="Seleccionar pago"
                  class="w-full input-container centered-control-mobile">
                </p-dropdown>
              </div>
        </div>
      </div>
    </div>
  </div>
    <!-- Modal de PayPal -->
  <p-dialog 
    [(visible)]="showPayPalDialog"
    [modal]="true"
    [closable]="!paypalLoading && !paymentCompleted"
    [style]="{ width: '500px', maxWidth: '95vw' }"
    [breakpoints]="{ '960px': '90vw', '640px': '95vw' }"
    header="Pago con PayPal"
    styleClass="paypal-dialog">
    
    <div class="paypal-content">
      
      <!-- Resumen del Pago -->
      <div class="payment-summary mb-4 p-3 surface-100 border-round">
        <h4 class="text-900 mb-3">Resumen de tu Reserva</h4>
        
        <div class="flex justify-content-between mb-2">
          <span class="text-600">Terraza:</span>
          <span class="font-semibold">${{ calculateTerracePrice() }}</span>
        </div>
        
        <div class="flex justify-content-between mb-2">
          <span class="text-600">Servicios:</span>
          <span class="font-semibold">${{ calculateServicesTotal() }}</span>
        </div>
        
        <p-divider></p-divider>
        
        <div class="flex justify-content-between align-items-center">
          <span class="text-900 font-bold text-lg">Total a Pagar:</span>
          <span class="text-green-500 font-bold text-2xl">
            ${{ calculateEventTotal() }}
          </span>
        </div>
      </div>

      <!-- Estado de Carga -->
      <div *ngIf="paypalLoading && !paymentCompleted" class="text-center py-4">
        <i class="pi pi-spin pi-spinner text-4xl text-primary mb-3"></i>
        <p class="text-600">Cargando opciones de pago...</p>
      </div>

      <!-- Contenedor de Botones de PayPal -->
      <div 
        id="paypal-button-container" 
        *ngIf="!paymentCompleted"
        class="paypal-buttons-container">
      </div>

      <!-- Confirmación de Pago Exitoso -->
      <div *ngIf="paymentCompleted" class="payment-success text-center py-4">
        <i class="pi pi-check-circle text-6xl text-green-500 mb-3"></i>
        <h3 class="text-900 mb-2">¡Pago Exitoso!</h3>
        <p class="text-600 mb-3">
          Tu reserva ha sido confirmada correctamente.
        </p>
        <p class="text-500 text-sm">
          ID de transacción: {{ paymentDetails?.id }}
        </p>
        <p class="text-600 mt-3">
          Redirigiendo a tus eventos...
        </p>
      </div>

      <!-- Información de Cuenta de Prueba -->
      <div *ngIf="!paymentCompleted" class="test-account-info mt-4 p-3 surface-50 border-round border-1 border-300">
        <h5 class="text-900 mb-2 flex align-items-center">
          <i class="pi pi-info-circle mr-2 text-blue-500"></i>
          Cuenta de Prueba PayPal
        </h5>
        <p class="text-600 text-sm mb-2">
          Usa estas credenciales para probar el pago:
        </p>
        <div class="grid text-sm">
          <div class="col-12">
            <strong>Email:</strong> sb-buyer&#64;business.example.com
          </div>
          <div class="col-12">
            <strong>Contraseña:</strong> 83&#64;OWxc0
          </div>
        </div>
        <p class="text-500 text-xs mt-2">
          * Estas son credenciales de sandbox para pruebas
        </p>
      </div>

    </div>

    <!-- Footer del Dialog -->
    <ng-template pTemplate="footer">
      <button 
        *ngIf="!paypalLoading && !paymentCompleted"
        pButton 
        label="Cancelar" 
        icon="pi pi-times"
        class="p-button-outlined p-button-secondary"
        (click)="closePayPalDialog()">
      </button>
    </ng-template>

  </p-dialog>
</div>